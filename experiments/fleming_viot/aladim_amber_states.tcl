variable freqs [list 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0 16.0 17.0 18.0 19.0 20.0]

variable constants [list 89.65504433102876 132.36805728714262]

variable cos_coeff [list \
[list 10.925059409295791 -21.66136580782129 -2.7895373467341336 5.4369063885197955 1.176181939348714 0.3789229429762116 1.536294817392581 -2.4446585054951755 -1.9764434441653584 2.3133472999188096 2.0671069219335387 -1.0871718885354087 -0.3204745549041543 0.32302781242604317 -1.1288150530225558 0.048393857534522945 1.1268046513268912 -0.5271898513510881 -1.1772616830867426 0.31974381235081195]\
[list 11.729947854576432 -7.865010718602845 0.7531272151817633 -8.999086246350002 7.143243646457394 -6.90850403372048 -0.4185059155221056 -0.3947120918657662 -0.18186044184508193 -0.16578448230295126 0.1275297296100867 -0.02372117512090208 -0.1377775784957994 0.9928425841385518 -0.6630949738767579 0.4718066102112124 -0.5647787230883118 0.12577280781401107 -0.24864183714528565 0.32568873878202387]\
]

variable sin_coeff [list \
[list -5.62499312919314 -8.117376293461753 8.914243891508388 4.9815107020830585 -0.889959462280119 -2.4158985513455034 -1.0094804378486826 0.5597986939770151 1.5855430425287254 1.4192508686893073 -0.35544523964094143 -1.361170937897676 -0.7856051954090216 0.578602965328282 0.395579576577979 -0.18144362288300903 -0.3319708562858742 -0.10994669112331455 0.5946416908526494 0.34143275086982466]\
[list 7.1392313533216925 -26.02007232254282 4.364970798217828 -6.0765934271306605 0.34083604277306284 2.1825341272202197 -2.7389777159644226 3.3811032085702872 -0.5494358093207385 0.45292830760974184 -0.7738479348245196 1.251551572874173 -0.5510966252639292 0.5304783580319339 -0.5874315686253581 -0.18852539092947498 0.23764198813029802 -0.0974245022694392 -0.18202991740853175 0.17462891474852643]\
]

proc calc_instate_id { id } {
    cv help
    set phi [cv colvar phi value]
    set psi [cv colvar psi value]

    # free energy minimum coordinates
    
    set phim 53.0
    set psim 28.0

    # translate to closest periodic image

    set phi [expr {abs($phi - 360 - $phim) < abs($phi - $phim) ? $phi - 360 : $phi}]
    set psi [expr {abs($psi - 360 - $psim) < abs($psi - $psim) ? $psi - 360 : $psi}]

    set phi [expr {abs($phi + 360 - $phim) < abs($phi + $phim) ? $phi + 360 : $phi}]
    set psi [expr {abs($psi + 360 - $psim) < abs($psi - $psim) ? $psi + 360 : $psi}]

    # compute polar coordinates

    set r [expr {sqrt(($phi - $phim)*($phi - $phim) + ($psi - $psim)*($psi - $psim))}]
    set t [expr {atan2($psi - $psim, $phi - $phim)}]

    set R [lindex $::constants $id]
    set i 0

    foreach f $::freqs {
        set R [expr {$R + [lindex $::cos_coeff $id $i]*cos($f*$t) + [lindex $::sin_coeff $id $i]*sin($f*$t)}]
        incr i
    }

    return [expr { $r < $R ? 1 : 0}]
}

proc calc_inbasin { args } { return [calc_instate_id 0] }
proc calc_inoptstate { args } { return [calc_instate_id 1] }
proc calc_inbasin_grad { args } { return 0.0 }
proc calc_inoptstate_grad { args } { return 0.0 }